<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--    Include the purecss.io CSS files for formatting and responsive design-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-4ZPLezkTZTsojWFhpdFembdzFudphhoOzIunR1wH6g1WQDzCAiPvDyitaK67mp0+" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <!--    Make sure the width is equal to the device's native width-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./styles.css" rel="stylesheet" type="text/css"/>

    <!--    Get jQuery-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <title>Genghis</title>
</head>
<body>
<!--Genghis Header-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div style="display:flex">
            <div>
                <a class="silent" href="../index.html">
                    <h1>Genghis</h1>
                    <h4>Bot Battle System</h4>
                </a>
            </div>
            <div id="header-info">
                <label for="cmb_game">Game:</label>
                <select name="game" id="cmb_game">
                </select>
                <br>
                <br>
                <label for="cmb_following">Following:</label>
                <select name="following" id="cmb_following">
                </select>
            </div>
        </div>
    </div>
</div>
<!--Battleground Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <svg xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="lightgrey"/>
                <text x="20" y="30">Battleground</text>
            </svg>
        </div>
    </div>
</div>
<!--Graph 1 Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>Graph 1</h2>
            <svg xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="lightgrey"/>
                <text x="20" y="30">Graph 1</text>
            </svg>
        </div>
    </div>
</div>
<!--Graph 2 Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>Graph 2</h2>
            <svg xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="lightgrey"/>
                <text x="20" y="30">Graph 2</text>
            </svg>
        </div>
    </div>
</div>
<!--Entity Info Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>Info about Followed Entity</h2>
            <pre>
{
  "game_dir": "games/2020-10-27T12:25:57.605449",
  "username": "adam",
  "bot_path": "games/2020-10-27T12:25:57.605449/adam/template_bot.py",
  "abbreviations": [
    "A"
  ],
  "bot_url": "https://people.cs.uct.ac.za/~KNXBOY001/genghis_client/template_bot.py",
  "name": "my bot",
  "coin_icon": "a",
  "bot_icon": "A",
  "stderr": "Traceback (most recent call last):\n  File \"template_bot.py\", line 180, in
            \n    main()\n  File \"template_bot.py\", line 75, in main\n    loc = this_battleground.find
_icon(bot_bg.bot_icon)\nNameError: name 'bot_bg' is not defined\n",
  "stdout": "Making motion BLOODTHIRSTY, bot is at (8, 19)\n",
  "move_dict": {
    "action": "walk",
    "direction": "r"
  },
  "len(coins)": 0
}
            </pre>
        </div>
    </div>
</div>
<script>
    function get_param(param, defaultvalue) {
        if (window.location.href.indexOf(param) > -1) {
            let vars = {};
            let parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,
                function (m, key, value) {
                    vars[key] = value;
                });
            return vars[param]
        }
        return defaultvalue;
    }

    // Update the list of running games
    $.ajax({
        url: "../server_state.json"
    }).done(data => {
        if (data && data['games']) {
            // Populate the list of games available
            let games_list = ["Overview"];
            data['games'].forEach((game) => {
                games_list.push(game['game_dir']);
            });
            let cmb_game = document.getElementById("cmb_game");
            cmb_game.setAttribute("onchange", "update_following()")
            cmb_game.innerHTML = "";

            let game_is_selected = false;
            for (let i = 0; i < games_list.length; i++) {
                let option = document.createElement("option");
                option.value = games_list[i];
                option.text = games_list[i];
                if (get_param("game", "") === games_list[i]) {
                    option.setAttribute("selected", "selected")
                    game_is_selected = true
                }
                cmb_game.appendChild(option);
            }
            if (!game_is_selected) {
                window.location.href = '../index.html';
            }
        }
    });

    let selected_game_path = get_param("game", "");
    $.ajax({
        url: "../" + selected_game_path + "/game.json"
    }).done(game => {
        let following_list = ["Overview"];
        game['bots'].sort((a, b) => a['bot_icon'] > b['bot_icon'] ? 1 : -1);
        game['bots'].forEach((bot) => {
            following_list.push(bot['bot_icon']);
        });

        game['battlegrounds'].sort((a, b) => a['port_icon'] > b['port_icon'] ? 1 : -1);
        game['battlegrounds'].forEach((bg) => {
            following_list.push(bg['port_icon']);
        });

        let cmb_following = document.getElementById("cmb_following");
        cmb_following.setAttribute("onchange", "update_following()");
        cmb_following.innerHTML = "";
        for (let i = 0; i < following_list.length; i++) {
            let option = document.createElement("option");
            option.value = following_list[i];

            if (i !== 0) {
                if (i - 1 < game['bots'].length) {
                    option.text = "Bot " + following_list[i];
                } else {
                    option.text = "Battleground " + following_list[i];
                }
            } else {
                option.text = following_list[i];
            }
            if (get_param("following", "") === following_list[i]) {
                option.setAttribute("selected", "selected")
            }
            cmb_following.appendChild(option);
        }
    });


    function update_following() {
        let cmb_following = document.getElementById("cmb_following");
        let cmb_game = document.getElementById("cmb_game");
        let forwarding_url;
        if (cmb_game.value !== 'Overview') {
            forwarding_url = 'follow.html?game=' + cmb_game.value;
            if (cmb_following.value !== 'Overview') {
                forwarding_url += '&following=' + cmb_following.value;
            }
        } else {
            forwarding_url = '../index.html';
        }
        window.location.href = forwarding_url;
    }

    // $(document).ready(function () {
    //     $.ajaxSetup({cache: false});
    //     let interval = 250;
    //
    //     function update() {
    //         $.when($.ajax('games/*'))
    //             .then(function (stateResponse) {
    //                 //console.log(stateResponse);
    //
    //                 updateWithState(stateResponse);
    //
    //             }, function () {
    //                 console.log('Error while loading gamestate/layout');
    //             });
    //         setTimeout(update, interval);
    //     }
    //
    //     setTimeout(update, interval);
    //
    //
    // });
    // Update the Games list
    // Update the bots/battlegrounds list
    // Update the Live Now card
    // Update the Preview map
    // Go to the top and update it all again


</script>

</body>
</html>
