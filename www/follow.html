<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!--    Include the purecss.io CSS files for formatting and responsive design-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-4ZPLezkTZTsojWFhpdFembdzFudphhoOzIunR1wH6g1WQDzCAiPvDyitaK67mp0+" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <!--    Make sure the width is equal to the device's native width-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./styles.css" rel="stylesheet" type="text/css"/>

    <!--    Get D3 for plotting-->
    <script src="https://d3js.org/d3.v4.js"></script>

    <!--    Get jQuery-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <title>Genghis</title>
</head>
<body>
<div class="pure-g">
    <!--Genghis Header Card-->
    <div class="pure-u-1-1">
        <div style="text-align: center;">
            <a class="silent" href="../index.html">
                <h1>Genghis</h1>
                <h4>Bot Battle System</h4>
            </a>
        </div>
    </div>
    <!-- Battleground Card-->
    <div class="pure-u-1-1">
        <div class="shadow" id="bg-card">
            <!--            This div populated by JavaScript-->
        </div>
    </div>
    <!--Graphs Card-->
    <div class="pure-u-1-1">
        <div class="shadow horizontal-scroll" id="graphs-card">
            <!--This div populated by JavaScript-->
        </div>
    </div>
</div>

<script src="diff_match_patch.js"></script>
<script type="module">
    import {
        get_param,
        draw_bot_locs,
        update_following,
        create_bg_card,
        create_graph_card
    } from './script.js';

    let game_param = get_param("game", "");
    let game;
    $.ajax({
        url: "../" + game_param + "/game.json",
        dataType: 'text'
    }).done(game_str => {
        game = JSON.parse(game_str);
        // When the game json is loaded, add content to the battleground and graphs cards
        create_bg_card('bg-card', game);
        create_graph_card('graphs-card', game);

        setInterval(() => {
            console.log(
                JSON.stringify({
                    'last_seen_tick': game.tick,
                    'game_id': game_param.replace('games/', '')
                })
            )
            $.ajax({
                url: "../get_gamestate.php",
                type: 'post',
                dataType: 'text',
                contentType: 'application/json',
                data: JSON.stringify({
                    last_seen_tick: game.tick,
                    game_id: game_param.replace('games/', '')
                }),
                success: (data, status, xhr) => {
                    let patch_strings = data.split('===---===');
                    let dmp = new diff_match_patch();
                    let patches = [];
                    for ( let i = 1; i < patch_strings.length; i++){
                        let sub_patches = dmp.patch_fromText(decodeURI(patch_strings[i]));
                        sub_patches.forEach((p) => {
                            patches.push(p);
                        })
                    }
                    game_str = dmp.patch_apply(patches, game_str)[0];
                    console.log(game_str)
                    try {
                        game = JSON.parse(game_str);
                    } catch (e) {
                        console.log(e);
                    }
                    create_bg_card('bg-card', game);
                    create_graph_card('graphs-card', game);
                }
            });
        }, 500);
    });


</script>
</body>
</html>
