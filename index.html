<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--    Include the purecss.io CSS files for formatting and responsive design-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-4ZPLezkTZTsojWFhpdFembdzFudphhoOzIunR1wH6g1WQDzCAiPvDyitaK67mp0+" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <!--    Make sure the width is equal to the device's native width-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="www/styles.css" rel="stylesheet" type="text/css"/>

    <!--    Get jQuery-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>


    <title>Genghis Bot Battle System</title>
</head>
<body>
<!--Genghis Header-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <h1>Genghis</h1>
        <h4>Bot Battle System</h4>
    </div>
</div>
<!--Live now Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <!--            Group for the left list-->
            <div class="pure-g">
                <div class="pure-u-8-24">
                    <h2>Live now</h2>
                    <ul id="games_list">
                        <li>No Games Live Right Now</li>
                    </ul>
                </div>
                <!--                Group for the RHS preview-->
                <div class="pure-u-16-24" id="cpb_plot">
                    <svg xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="lightgrey"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>
<!--What's this Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>What is This?</h2>
            <p>Using the Genghis Battle System by
                <a href="https://github.com/beyarkay">Boyd Kane</a>,
                bots built by Computer Science students compete for
                resources, trade, and fight each other across
                multiple different battlegrounds.</p>
        </div>
    </div>
</div>
<!--Make a bot Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>Make Your Own Bot</h2>
            To get started, you will need to copy some code from a
            <a href="https://github.com/beyarkay/genghis_client">GitHub
                repository</a> into an internet-connected sever (like UCT's
            nightmare server that all second-year students have access to). <br>
            <ol>
                <li>ssh into the UCT server:
                    <code>ssh &lt;YOUR_STUDENT_NUMBER&gt;@nightmare.cs.uct.ac.za</code>
                </li>
                <li>Make a public directory to host the bot script, and change into it:
                    <code>mkdir ~/public_html && cd ~/public_html</code>
                </li>
                <li>Get a copy of the scripts needed to setup your bot, and then
                    change into the newly created directory:
                    <code>git clone https://github.com/beyarkay/genghis_client.git && cd genghis_client</code>
                </li>
                <li>Run a script to get you started:
                    <code>python3 get_started.py</code>
                </li>
                <li>At the prompts, enter the server's URL:
                    <code>https://people.cs.uct.ac.za/~KNXBOY001/genghis_server</code>
                    your URL:
                    <code>https://people.cs.uct.ac.za/~&lt;YOUR_STUDENT_NUMBER&gt;/genghis_client</code>
                    and what you want your username to be:
                    <code>Username: &lt;CHOOSE A USERNAME&gt;</code>
                </li>
                <li>All done! Your bot will be included in the next game.
                </li>
            </ol>
        </div>
    </div>
</div>

<script>
    function get_param(param, defaultvalue) {
        var urlparameter = defaultvalue;
        if (window.location.href.indexOf(param) > -1) {
            let vars = {};
            let parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,
                function (m, key, value) {
                    vars[key] = value;
                });
            return vars[param]
        }
        return defaultvalue;
    }

    function draw_coins_per_bot(div_id, selected_game_path) {
        // let selected_game_path = get_param("game", "");

        $.ajax({
            url: "../" + selected_game_path + "/bot_info.json"
        }).done(bot_info => {
            let COLOURS = ["#c4ad3a",
                "#715fcd",
                "#73b638",
                "#c24cb5",
                "#4fbd6a",
                "#da4478",
                "#55b48f",
                "#d04934",
                "#49b9d3",
                "#d9842d",
                "#6380c5",
                "#687428",
                "#be86dd",
                "#3d7d3e",
                "#d983b3",
                "#a3b165",
                "#97487a",
                "#97692f",
                "#b35355",
                "#e29371"]
            const MAX_HISTORY = 500; // Only show ticks upto 300 ticks in the past
            let unique_bots = [];
            let bots = [];
            for (let i = 0; i < bot_info.length; i++) {
                if (!unique_bots.includes(bot_info[i]['bot_icon'])) {
                    unique_bots.push(bot_info[i]['bot_icon']);
                    bots.push([]);
                }
            }

            unique_bots.sort((a, b) => (a < b) ? -1 : 1);
            const present = d3.max(bot_info, (d) => d.tick);
            // Restructure the data. Each element in data corrosponds to a different bot's data
            for (let i = 0; i < bot_info.length; i++) {
                if (bot_info[i].tick >= present - MAX_HISTORY) {
                    bots[unique_bots.indexOf(bot_info[i].bot_icon)].push(bot_info[i]);
                }
            }

            // set the dimensions and margins of the graph
            const margin = {top: 10, right: 70, bottom: 50, left: 40};
            const width = document.getElementById(div_id).offsetWidth - margin.left - margin.right
            const height = 400 - margin.top - margin.bottom

            d3.select('#' + div_id).selectAll("svg").remove();
            // append the svg object to the body of the page
            const svg = d3.select('#' + div_id)
                .append("svg")
                .attr("height", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const xScale = d3.scaleLinear()
                .domain([Math.max(0, present - MAX_HISTORY), present])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain(d3.extent(bot_info, (e) => e.total_coins))
                .range([height, 0]);

            const colour = d3.scaleOrdinal()
                .domain(unique_bots)
                .range(COLOURS.splice(0, unique_bots.length));

            // Filter out all the fractional ticks for total_coins:
            const yAxisTicks = yScale.ticks()
                .filter(tick => Number.isInteger(tick));
            const yAxis = d3.axisLeft(yScale)
                .tickValues(yAxisTicks)
                .tickFormat(d3.format('d'));

            const line = d3.line()
                .x(d => xScale(d.tick))
                .y(d => yScale(d.total_coins));

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale))
                .append("text")
                .attr("y", '2.5em')
                .attr("x", 0)
                .style("text-anchor", "start")
                .style("alignment-baseline", "bottom")
                .text("Game tick");

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", '-1.5em')
                .attr("x", 0)
                .style("text-anchor", "end")
                .text("Number of coins");


            let x_offset = 5;
            let y_offset = 0;
            for (let i = 0; i < bots.length; i++) {
                let legend = svg.append('g')
                    .datum(bots[i])
                    .attr('class', 'legend')
                    .on('mouseover', () => { // on mouse in show line, circles and text
                        d3.selectAll("path.line").style("opacity", d => d[0].bot_icon === bots[i][0].bot_icon ? 1.0 : 0.3);
                    })
                    .on('mouseout', () => { // on mouse out hide line, circles and text
                        d3.selectAll("path.line").style("opacity", 0.9);
                    });
                if (y_offset > height) {
                    x_offset += 30;
                    y_offset = 0;
                }

                legend.append('rect')
                    .attr('x', width + x_offset)
                    .attr('y', (d, _) => y_offset)
                    .attr('width', 10)
                    .attr('height', 10)
                    .style('fill', d => colour(d[0].bot_icon));
                legend.append('text')
                    .attr("alignment-baseline", 'middle')
                    .attr('x', width + 12 + x_offset)
                    .attr('y', (d, _) => (y_offset) + 7)
                    .text(d => d[0].bot_icon);
                y_offset += 20
                svg.append("path")
                    .datum(bots[i])
                    .attr("class", "line")
                    .style("opacity", "0.9")
                    .style("stroke", d => colour(d[0].bot_icon))
                    .attr("d", line)
                    .on('mouseover', () => { // on mouse in show line, circles and text
                        d3.selectAll("path.line").style("opacity", d => d[0].bot_icon === bots[i][0].bot_icon ? 1.0 : 0.3);
                    })
                    .on('mouseout', () => { // on mouse out hide line, circles and text
                        d3.selectAll("path.line").style("opacity", "0.9");
                    });

            }
        });
    }

    $.ajax({
        url: "server_state.json"
    }).done(data => {
        if (data && data['games']) {
            console.log("Data found: ", data['games']);
            // Update the list of games
            let ul = document.getElementById("games_list");
            ul.innerHTML = "";
            // Attempt to get the files for the bots / battlegrounds
            let selected_game_path;
            data['games'].sort((a, b) => a['game_dir'] < b['game_dir'] ? -1 : 1)
            for (let i = 0; i < data['games'].length; i++) {
                let game = data['games'][i];
                let li = document.createElement("li");
                let a = document.createElement("a");
                a.setAttribute("href", "www/follow.html?game=" + game['game_dir']);
                a.innerHTML = game['game_dir'].replace('games/', '');
                li.appendChild(a);
                ul.appendChild(li);
                selected_game_path = game['game_dir'];
            }
            draw_coins_per_bot('cpb_plot', selected_game_path);
        }
    });


</script>
</body>
</html>