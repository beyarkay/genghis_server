<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--    Include the purecss.io CSS files for formatting and responsive design-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-4ZPLezkTZTsojWFhpdFembdzFudphhoOzIunR1wH6g1WQDzCAiPvDyitaK67mp0+" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <!--    Make sure the width is equal to the device's native width-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="styles.css" rel="stylesheet" type="text/css"/>

    <!--    Get jQuery-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <link rel="icon" type="image/ico" href="./favicon.ico"/>
 
    <title>Genghis Bot Battle System</title>
</head>
<body>
<!--Genghis Header-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div style="text-align: center;">
            <a class="silent" href="./index.html">
                <h1>Genghis</h1>
                <h4>Bot Battle System</h4>
            </a>
        </div>
    </div>
</div>
<!--Live now Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <!--            Group for the left list-->
            <div class="pure-g">
                <div class="pure-u-1-1">
                    <h2>Games:</h2>
                    <ul id="games_list">
                        <li>No Games</li>
                    </ul>
                </div>
                <!--                Group for the RHS preview-->
                <!--
                <div class="pure-u-16-24" id="cpb_plot">
                    <svg xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="lightgrey"/>
                        <text x="20" y="30">Loading Game Preview...</text>
                    </svg>

                </div>
                -->
            </div>
        </div>
    </div>
</div>
<!--What's this Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>What is This?</h2>
                Using the Genghis Battle System by
                <a href="https://github.com/beyarkay">Boyd Kane</a>,
                bots built by Computer Science students compete for
                resources, trade, and fight each other across
                multiple different battlegrounds.
                <br><br>Click the red link above to see a game in action.
        </div>
    </div>
</div>
<!--Make a bot Card-->
<div class="pure-g">
    <div class="pure-u-1-1">
        <div class="shadow">
            <h2>Make your own bot</h2>
            This will guide you through making a private GitHub repository which is
            where the code for your bot will live. It will then show you how to copy some 
            existing code into that repository in order to get you started.
            <ol>
                <li>
                    <a href="https://github.com/new" target="_blank">Click here</a> to create 
                    new github repository. Give it a name like 'my_genghis_client' or 'genghis-bot-9000', and then 
                    make sure you click 'Private', so that nobody else can steal your code!
                    <br> Leave all the checkboxes unticked and click 'Create repository'.
                </li>
                <li>
                    You'll be taken to a page with lots of stuff. Ignore it all, copy
                    the URL of the repository and paste it below:
                    <input type="text" style="width: 90%;" id="url" onkeyup="txtbox_github_url(this, event)"/>
                    <br><code id="err" style="display:none; color:red;"></code>
                </li>
                <li>
                    Run the following lines in a *nix/MacOS terminal<span class="blurb">, making sure to
                    replace MY_USERNAME with your github username and MY_REPO_NAME with your repository's 
                    name</span>:
                    <code>
                        git clone --bare https://github.com/beyarkay/genghis_client.git <br>
                        cd genghis_client.git <br>
                        git push --mirror git@github.com:<span class="username">MY_USERNAME</span>/<span class="repo_name">MY_REPO_NAME</span>.git <br>
                        cd ..  <br>
                        rm -rf genghis_client.git<br>
                        git clone git@github.com:<span class="username">MY_USERNAME</span>/<span class="repo_name">MY_REPO_NAME</span>.git<br>
                        cd <span class="repo_name">MY_REPO_NAME</span><br>
                        git branch -M main<br>
                        git push -u origin main <br>
                    </code>
                    <br>If you get an error like:
                    <code>
                        ERROR: Repository not found.
                        <br>fatal: Could not read from remote repository.
                    </code>
                    Then you github doesn't know that the computer you're using actually belongs to you, 
                    and that it's allowed to access your private repository. You'll need to 
                    <a href="https://docs.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" target="_blank">
                    generate a new ssh key</a>, add it to the ssh-agent (follow the instructions in the link), and then
                    <a href="https://docs.github.com/en/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account" target="_blank">
                    add that ssh key to your github account</a>.
                    <br>Once you've added the ssh key to your github account, run the lines of code again and it will 
                    succeed.
                </li>
                <li>
                    And now you're able to <a href="https://github.com/beyarkay/genghis_client/wiki/Building-Your-Bot" target="_blank">
                    start building your bot</a>. However, if you want to compete against other bots
                    on the genghis server, you'll want to:
                </li>
            </ol>
            <br>
            <h2>Register your bot with the Genghis Server</h2>
                In this step you add a <a href="https://docs.github.com/en/free-pro-team@latest/developers/overview/managing-deploy-keys#deploy-keys">deploy key</a> to your private repository. This will let Genghis
                (and only Genghis) have read-only access to your repository so that it can fetch the code
                you write and execute it in an actual game.
            <ol>
                <li class="blurb">
                    First, go back to 'Make your own bot' and copy the URL of your github repository 
                    into the text field (I know you haven't done it yet).
                </li>
                <li id="li_to_deploy_key">
                    Now click: The three little dots in the top right &gt; Settings &gt; Deploy Keys &gt; Add Deploy Key.
                </li>
                <li>
                    Choose a title for the deploy key, something like 'Genghis Server Deploy Key', then click the button below to copy your generated public deploy key to your clipboard:
                    <code id='public_key'>Enter a valid GitHub URL under the 'Make your own bot' heading to generate your public deploy key</code>
                    <button type="button" onclick="btn_copy_public_key()" style="display: none;" id="btn_copy_public_key">
                        Copy public deploy key to clipboard</button> 
                    Paste this public deploy key in the big text box labeled 'Key' on GitHub.
                    <br>This key will give the Genghis Battle System read-only access to your repository, so that it's
                    code can be run and your bots can be included in battles.
                </li>
                <li>
                    Click 'Add key', and then enter your password. You'll get an email letting you know that a new
                    key has been added.
                </li>
                <li>
                    Almost done! The Genghis Server knows about your repository, but is just checking that 
                    everything's in order and that it can read your repository correctly. This page will
                    automatically update when you've been verified. Please make sure you can see the key you just
                    created <span id='span_to_view_key'>at your repository's Deploy keys tab under Settings</span>.
                    <br><br>While you wait, you can continue to the next section if you'd like.
                    <br><code id='register_err' style='display:none;color:red;'></code>
                </li>
                <li id="final" style="display:none">
                    All done! Your bot will be included in the next game which you can view by clicking the red link at 
                    the top of this page.
                    <br> Whenever a new game starts, Genghis will pull the changes from your private repository
                    using the deploy key and then attempt to run the bot it finds in your repository.
                    <br>Simply pushing your changes to your github repository will cause them to be included in 
                    the next Genghis game.
                    <br><br> So this is all good, but you can't actually <i>run</i> your bot just yet. For that 
                    you'll need a copy of the Genghis server which will allow you to:
                </li>
            </ol>
            <br>
            <h2>Test your bot on localhost</h2>
                So far you've got what you need to write your bot, and the Genghis Battle System
                will grab your code from the GitHub repository and run your bot against all 
                the other bots, but you can't actually <i>run</i> your bot code.
                <br><br>This step shows you how to download the Genghis Server, so that you can
                start up your own game where you can fight your bot against copies of itself
                and make sure your bot code does what you want it to do. 
            <ol>
                <li>
                   Run the following lines in a linux/MacOS terminal to clone 
                   the <a href="https://github.com/beyarkay/genghis_server">genghis_server</a> 
                   github repository. 
                   <code>
                        git clone https://github.com/beyarkay/genghis_server.git <br>
                        cd genghis_server<br>
                        chmod +x build_game.py
                    </code> 
                </li>
                <li>
                    Running the below line will start a game on localhost at port 5000, 
                    using the two copies of the bot found at ~/<span class="repo_name">genghis_client</span>,
                    can visit http://localhost:5000/ to view the game.
                    
                    <br>There will also be lots of debugging output printed to the terminal while the game is running.
                    You can press CTRL-C to stop the program at any time.
                   <code>
                        ./build_game.py --localhost 5000 --client_dir ~/<span class="repo_name">genghis_client</span> --client_dir ~/<span class="repo_name">genghis_client</span> 
                    </code> 
                </li>
            </ol>
        </div>
    </div>
</div>
<script>
let username;
let repo_name;
let url;
function txtbox_github_url(input_element, event) {
    /*
    When a user enters their github repo URL, there are several things
    that get done automagically to make the process easier:
    0. Check that the given URL matches a github url regex.
    1. Extract the github username and repository name, then use
        these values to populate the rest of the page with correct
        commands for their use case
    2. Make a POST request to the server to generate a new keypair for
        each new user.
        - The public key is returned and displayed to the user to copy.
    */
    const regex = /^https:\/\/github\.com\/(\w|-|\.|_)+\/(\w|-|\.|_)+$/gm;
    // Check if the given url matches a github repository URL regex
    if (regex.test(input_element.value)) {
        // Calculate & get some useful values
        url = input_element.value;
        username = url.split('/')[3];
        repo_name = url.split('/')[4];
        const url_deploy = url + "/settings/keys/new";
        // Update the quick link to add a new deploy key
        document.getElementById("li_to_deploy_key").innerHTML = 
            `Click <a href='${url_deploy}' target="_blank">here</a> to add a new key to your repository.`;
        document.getElementById("span_to_view_key").innerHTML = `<a href='${url}/settings/keys' target="_blank">here</a>`;
        // Remove any error messages that might exist from previous failed attempts
        document.getElementById("err").style.display = 'none';
        document.getElementById("register_err").style.display = 'none';
        // Go through all the username / repo / blurb placeholders and replace them appropriately
        let usernames = document.getElementsByClassName("username");
        for (let i = 0; i < usernames.length; i++) {
            usernames[i].innerHTML = username;
        }
        let repo_names = document.getElementsByClassName("repo_name");
        for (let i = 0; i < repo_names.length; i++) {
            repo_names[i].innerHTML = repo_name;
        }
        let blurbs = document.getElementsByClassName("blurb");
        for (let i = 0; i < blurbs.length; i++) {
            blurbs[i].style.display = 'none';
        }

        // Get and populate an ssh key
        document.getElementById('public_key').innerHTML =
            `${new Date().toLocaleTimeString()}: A request to generate a public deploy key for you has been sent...`;
        $.post("requests.php", JSON.stringify({
            case: 'add_new_client',
            username: `${username}`,
            repository: `${repo_name}`,
            url: `${url}`,
        })).done(function(d) {
            console.log(d);
            document.getElementById('public_key').innerHTML += 
                `<br>${new Date().toLocaleTimeString()}: Your public deploy key is being generated...`;
            // Make another request, this time to actually get the public key
            $.post("requests.php", JSON.stringify({
                case: 'wait_for_public_key',
                username: `${username}`,
                repository: `${repo_name}`,
                url: `${url}`,
            })).done(function(d) {
                console.log(d);
                document.getElementById('public_key').textContent = d['public_key'];
                document.getElementById('public_key').style = 'display: none;';
                document.getElementById('btn_copy_public_key').style = 'display: block;';
            }).fail(function(d) {
                console.log(d['responseText']);
                document.getElementById('public_key').innerHTML += 
                    `<br>${new Date().toLocaleTimeString()}: Your public deploy key was generated, but could not be retrieved from the server.`;
            });        
        }).fail(function(d) {
            console.log(d['responseText']);
            document.getElementById('public_key').innerHTML = `Your public deploy key failed to generate: ${d['response_text']['message']}`;
        });        
    } else {
        document.getElementById("err").innerHTML = "Error: the URL you entered doesn't match the regex " + regex;
        document.getElementById("err").style.display = 'block';
    }
}
function btn_copy_public_key() {
    let public_key = document.getElementById('public_key').innerHTML;
    navigator.clipboard.writeText(public_key).then(function() {
        document.getElementById('btn_copy_public_key').innerHTML = "Copied!";
        console.log('Async: Copying to clipboard was successful!');
    }, function(err) {
        console.error('Async: Could not copy text: ', err);
        document.getElementById('public_key').style = 'display: block;';
    });
    $.post("requests.php", JSON.stringify({
        case: 'wait_for_access_granted',
        username: `${username}`,
        repository: `${repo_name}`,
        url: `${url}`,
    })).done(function(d) {
        document.getElementById('final').style = 'display: block;';
        console.log(d);
    }).fail(function(d) {
        console.log(d['responseText']);
        console.log(d);
    });        
}
</script>
<script type="module">
    $.ajax({
        url: "server_state.json"
    }).done(data => {
        if (data && data['games']) {
            console.log("Data found: ", data['games']);
            // Update the list of games
            let ul = document.getElementById("games_list");
            ul.innerHTML = "";
            data['games'].sort((a, b) => a['game_dir'] > b['game_dir'] ? -1 : 1)
            for (let i = 0; i < data['games'].length; i++) {
                if (i > 10) {
                    let li = document.createElement("li");
                    // let a = document.createElement("a");
                    li.innerHTML = '...';
                    // li.appendChild(a);
                    ul.appendChild(li);
                    break;
                }
                let game = data['games'][i];
                let li = document.createElement("li");
                let a = document.createElement("a");
                a.setAttribute("href", "follow.html?game=" + game['game_dir'] + "&v=" + Date.now());
                a.innerHTML = "Game started on " + game['game_dir'].replace('games/', '').replace("T", " at ").replace(/:\d{2}\.\d{6}/, "" );
                a.style.color = i === 0 ? "#b30c0c" : "#a0a0a0";
                li.appendChild(a);
                ul.appendChild(li);
            }
            // draw_coins_per_bot('cpb_plot', selected_game_path);
        }
    });
</script>
</body>
</html>
